#BlueDog WP Installer - Dev Docs

##Overview

BlueDog WP Installer is a WordPress installation script that can run in a browser or via command line. These development docs will review the architecture and general layout of the code base.


#History 

The project was forked from the WP Quick Installer Project developed by  .

To date, the major differences from WP Quick Installer are:

* The code was refactored into a PHP class that does the heavy lifting
* Command Line Support was added
* A different front end was added, replacing nearly all the original html and javascript
* The original javascript used separate ajax requests for each installation action. The new script loops through a configurable array of actions supplied by the server side script to repeatedly call the same ajax call until all actions are completed. This allows greater flexibility in adding or re-ordering actions without having to edit the javascript.
* The original script parsed ini files for configuration. BlueDog Installer instead uses 2 configuration files that are PHP scripts. The original instigator for this was the inability for the ini parser to handle complex passwords.
* Passwords are handled more securely - the database password is never revealed or editable on the browser page, and the WP admin password is automatically generated by a cryptographically secure function with no option for the user to create their own. This not only ensures a strong password, but it also means there is no risk that the same password will be used for each new installation.
* Configuration options were renamed to be more consistent with WordPress standards.  See the Configuration section for more detail.
* Site Profiles were added. Profiles contain non-site specific installation options such as which  plugins and themes should be installed. They should not contain any options that require you to specify a options that can't be used for multiple sites (for example, domain name or admin user name)

#Why use BlueDog WP Installer instead of other installation scripts?

Here are the main benefits that make our installer stand out from the rest:

* Installation Profiles - You can create one installation profile and reuse it for multiple site setups. For example, does one of your clients have a set of plugins they always want activated? No problem, create one profile for them and reuse it for each install - you'll always install the latest plugin versions and even install their premium themes or plugins.
* Install via command line. - Do  you prefer the command line? As long as you have a PHP CLI interpreter installed (most PHP installations do), you can run the installer from the command line.
* No special installation requirements. The Installer script doesn't use bash or anything other than whats required for a typical WordPress installation.
* More secure
    -   You are never allowed to choose your own WP Admin password on installation, the script always creates one for you. 
    -   wp-config.php is moved to outside the web root.
    -   Secure File permissions are set automatically.


**In addition:**

* You always get the latest version of WordPress and any free plugins you've configured in your profile settings'
* You can add demo content and remove default WordPress content like the 'Hello World' post and comments.
* You can remove the default plugins and themes like TwentyEleven and Hello Dolly


#Configuration 

Configuration settings are divided into 2 categories, Site and Profile. These map to the site-config.php and profile-config.php files. Within those files, there is one configuration variable $site or $profile which is an array. Each array element's primary and secondary index indicates how they map to WordPress's configuration. Primary indexes are used to indicate whether the configuration paramater is part of the `wp-config` file or a table in the WordPress database, usually the `wp_options` table

Configuration names map as closely as possible their WordPress counterparts. Instead of the original project's `username` paramater, for example, we now have **`['wp-config']['DB_USER']`** which tells you that we are configuring the `DB_USER paramater` in the `wp-config` file. `$site[ 'wp_users' ][ 'user_login' ]` tells you were are configuring the `user_login` value in the `wp_users` table. **`$site[ 'wp_options' ][ 'blogname' ]`** tells you we are configuring the `blogname` value in the `wp_options` table. If no secondary index is given, for example, **`$site[ 'profile' ]`**, the setting is only used by the installer and doesn't map to a standard WordPress configuration option.
    
#Dev Configuration

Configuration of the code base can be done using the `_config` method. 

This is where you configure such things as the location of the cache and configuration files. 

Most of the options are self-explanatory or should be understandable from the comments.

#Installation Profiles

An installation profile are the WordPress settings, custom themes and plugins required for your installation. They should not include any site specific settings such as site name or description.

An installation profile is configured by editing the $site['profile'] setting. 

To create a new profile, copy the profiles/default directory and rename it to the name of your profile. Change the $site['profile'] setting to the name of the directory. Edit the `profiles/profile-name/profile-config` file as needed to fit your installation requirements, and add any custom themes or plugins to the either the `themes` or `plugins` subdirectory.

#Leverage Profiles to save time

Here are some ways you can use profiles to save time:

* Create a 'base' profile that includes your favorite backup, caching, gallery or other plugins that you want installed 'by default' when you run your install script
* Create a profile for each client so you know exactly what was installed and so you can replicate their installation for similar sites they may want to build.
* Use GitHub to share profiles with your team. Use your source control repository such as GitHub to share installation profiles that work best for your team.



#Usage  (draft)

##Configuration

**after editing the site-config.php or profile-config.php file, you must do a hard refresh of the page before the changes will be seen**




http://wp-quick-install-dev.com/bplate-wpi/?action=install&last_action=wpSuccessMessage&reinstall=false

http://wp-quick-install-dev.com/bplate-wpi/?action=install&last_action=wpSuccessMessage&reinstall=false


###True vs 1, on, off ,etc

In your configuration files, try to use true or false for all boolean values, without quotes. The code uses convertToBool to do  a scrub of all SITE_CONFIG and PROFILE_CONFIG strings that are '1','0','on','off','true','false','yes' or 'no', converting them to boolean. It leaves 1 and 0 without quotes (i.e, numeric values) alone.



#Bugs and Troubleshooting

**Table 'dbname.wp_options' doesn't exist'**

This occurred intermittently during testing when reinstall=true. The only way that appeared to fix it was to delete wp-config.php, replace it with a copy of config-sample.php with database values replaced for correct connection credentials, and rerun setup with $site[ 'wpDownload' ] = false and $site[ 'wpConfig' ] = false. Once it works, re-run it again with wpConfig enabled so you can get back your configuration. Not sure why this fixes it, it may have something to do with permissions on wp-config.php. 

**Fatal error: Uncaught exception 'ErrorException' with message Directory not empty**

This error may happen when running from a command line. Try again and it should work without error.



**No output after _wpIncludeWP is called**

**Persistent retrys**

A 'retry' mechanism was added to try to overcome what is probably a timing limitation that doesn't always allow wpUnzip or wpConfig to complete. 3 retrys are attempted and if they all fail, the installation fails. Usually if you just do a hard refresh of the page and restart the install it will work.


**Exception Info**

You can get more info on exceptions by setting $site[ 'debug-show-exceptions' ] = true;


**Temporarily Overriding Configuration values Using Query String Paramaters**

The default behavior of the script is to allow you to edit via the browser only those values allowable via the $this->EDITABLE_PROPS value which makes the form input field editable instead of hidden.

    $this->EDITABLE_PROPS[ 'wp_options' ][ 'blogname' ] = 1;

This leaves the other values 'uneditable' via the form, although you can temporarily override a value by adding SITE_CONFIG or PROFILE_CONFIG to the query string of the url that calls the script.


To demonstrate, you would normally call the script using something like this: 

    http://wp-quick-install-dev.com/bplate-wpi/

Override a Site COnfiguration value

     http://wp-quick-install-dev.com/bplate-wpi/?SITE_CONFIG[wpConfig]=false

Override Both a Site Configuration and a Profile Configuration value

    http://wp-quick-install-dev.com/bplate-wpi/?SITE_CONFIG[wpConfig]=false&PROFILE_CONFIG[wp_options][permalink_structure]=test


You can always of course edit a value by directory editing the site-config.php or profile-config.php files.


**Command Line Usage**

You should be able to call the script using any of the following:

    php index.php

or using the same php executable used by uWAMP:
 
     "/c/UwAmp/bin/php/php-5.3.25/php" -f index.php

or using the same php.ini used by uWAMP, but a different executable:

    php -c "/c/UwAmp/bin/apache" index.php



To find the ini used by uWAMP, just add phpinfo() in the sandbox method.

Issues with Command Line Usage:

**stream_socket_client() errors**

This is likely due to HTTP_HOST not being set to a resolvable host.

We did see this error and fixed it by setting WP_SITEURL before wp_install was callled, setting it to a value calculated from `_wpGetSiteUrl`


